import { supabaseAdmin } from '@/lib/supabase';
import { NextResponse } from 'next/server';

const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;
const MODEL = 'google/gemini-2.5-flash-lite';

// Category mapping: English slug -> Bulgarian display name
const CATEGORY_LABELS: Record<string, string> = {
  'dairy-products': '–ú–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏',
  'recipes': '–†–µ—Ü–µ–ø—Ç–∏',
  'health': '–ó–¥—Ä–∞–≤–µ',
  'culture': '–ö—É–ª—Ç—É—Ä–∞',
  'products': '–ü—Ä–æ–¥—É–∫—Ç–∏',
  'tradition': '–¢—Ä–∞–¥–∏—Ü–∏–∏',
  'guides': '–ì–∏–¥-–æ–≤–µ'
};

// –†–ï–ê–õ–ù–ò pillar suggestions based on category
function getSuggestedPillars(category: string, clusterTitle: string): string[] {
  const suggestions: Record<string, string[]> = {
    'recipes-yogurt': [
      '–¢–∞—Ä–∞—Ç–æ—Ä - –∫–ª–∞—Å–∏—á–µ—Å–∫–∞—Ç–∞ —Ä–µ—Ü–µ–ø—Ç–∞',
      '–°–Ω–µ–∂–∞–Ω–∫–∞ (—Å–∞–ª–∞—Ç–∞ —Å —Ü–µ–¥–µ–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –∫—Ä–∞—Å—Ç–∞–≤–∏—Ü–∏, —á–µ—Å—ä–Ω –∏ –∫–æ–ø—ä—Ä)',
      '–Ø–π—Ü–∞ –ø–æ –ø–∞–Ω–∞–≥—é—Ä—Å–∫–∏',
      '–ú—É—Å–∞–∫–∞ —Å –∫–∞—Ä—Ç–æ—Ñ–∏ –∏ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ',
      '–¢–∏–∫–≤–∏—á–∫–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –Ω–∞ —Ñ—É—Ä–Ω–∞',
      '–ö–µ–∫—Å —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ',
      '–ö–∞—Ç–º–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ',
      '–ê–π—Ä—è–Ω - –∫–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–∏—è—Ç –∞–π—Ä—è–Ω'
    ],
    'recipes-cheese': [
      '–ö–ª–∞—Å–∏—á–µ—Å–∫–∞ –±–∞–Ω–∏—Ü–∞ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ',
      '–ü—ä—Ä–∂–µ–Ω–∏ —Ñ–∏–ª–∏–π–∫–∏ —Å —è–π—Ü–µ –∏ —Å–∏—Ä–µ–Ω–µ',
      '–ë—É—Ö—Ç–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ',
      '–ú–∏—à-–º–∞—à –ø–æ —Å–µ–ª—Å–∫–∏',
      '–°–∏—Ä–µ–Ω–µ –ø–æ —à–æ–ø—Å–∫–∏',
      '–ö–∞—á–∞–º–∞–∫ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –∏ –º–∞—Å–ª–æ',
      '–ü—ä–ª–Ω–µ–Ω–∏ —á—É—à–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –∏ —è–π—Ü–µ',
      '–ö–∞—Ä—Ç–æ—Ñ–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –Ω–∞ —Ñ—É—Ä–Ω–∞'
    ],
    health: [
      'Lactobacillus bulgaricus - –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ –º–ª–µ—á–Ω–∞ –±–∞–∫—Ç–µ—Ä–∏—è',
      '–ö–∞–∫ –∫–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –ø–æ–¥–ø–æ–º–∞–≥–∞ —Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞–Ω–µ—Ç–æ',
      '–†–æ–ª—è—Ç–∞ –Ω–∞ –∫–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –∑–∞ –∏–º—É–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞',
      '–ö–∞–ª—Ü–∏–π –≤ –º–ª–µ—á–Ω–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ –∑–¥—Ä–∞–≤–∏ –∫–æ—Å—Ç–∏',
      '–ö–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –≤ —Ö—Ä–∞–Ω–µ–Ω–µ—Ç–æ –Ω–∞ –¥–µ—Ü–∞',
      '–ü—Ä–æ–±–∏–æ—Ç–∏—Ü–∏ –∏ —á—Ä–µ–≤–Ω–æ –∑–¥—Ä–∞–≤–µ - –Ω–∞—É—á–Ω–∏ —Ñ–∞–∫—Ç–∏'
    ],
    culture: [
      '–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∫–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –≤ –ë—ä–ª–≥–∞—Ä–∏—è',
      '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –Ω–∞ —Å–∏—Ä–µ–Ω–µ',
      '–û—Ç–∫—ä–¥–µ –∏–¥–≤–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ—Ç–æ –º–ª—è–∫–æ: –†–æ–ª—è—Ç–∞ –Ω–∞ –ø–∞—Å–∏—â–∞—Ç–∞',
      '–ë—ä–ª–≥–∞—Ä—Å–∫–∏—Ç–µ –º–ª–µ—á–Ω–∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –æ–±–∏—á–∞–∏',
      '–ö–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –≤ –±—ä–ª–≥–∞—Ä—Å–∫–∏—è —Ñ–æ–ª–∫–ª–æ—Ä',
      '–ú–µ—Å—Ç–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Å—Ä–µ—â—É –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–æ'
    ],
    products: [
      '–ö–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ –∏—Å—Ç–∏–Ω—Å–∫–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ',
      '–†–∞–∑–ª–∏–∫–∞ –º–µ–∂–¥—É –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –∞–π—Ä—è–Ω –∏ –∫–∞—Ç—ä–∫',
      '–í–∏–¥–æ–≤–µ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ: –ö—Ä–∞–≤–µ, –æ–≤—á–µ, –∫–æ–∑–µ',
      '–ü—Ä–∞–≤–∏–ª–Ω–æ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏',
      '–ö–∞–∫ –¥–∞ –∏–∑–±–µ—Ä–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –≤ –º–∞–≥–∞–∑–∏–Ω–∞',
      '–ë–µ–∑ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–∏ –≤ –º–ª–µ—á–Ω–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏ - –∑–∞—â–æ –µ –≤–∞–∂–Ω–æ'
    ],
    tradition: [
      '–ö–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ —Ç—Ä–∞–ø–µ–∑–∞ –ø—Ä–µ–∑ –≤–µ–∫–æ–≤–µ—Ç–µ',
      '–ú–ª–µ—á–Ω–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏ –ø–æ –≤—Ä–µ–º–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–∑–Ω–∏—Ü–∏',
      '–°—Ç–∞—Ä–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –æ–±–∏—á–∞–∏, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å –º–ª—è–∫–æ—Ç–æ',
      '–†–µ—Ü–µ–ø—Ç–∏ –æ—Ç —Ç–µ—Ñ—Ç–µ—Ä–∞ –Ω–∞ –±–∞–±–∞: –ú–ª–µ—á–Ω–∏ —è—Å—Ç–∏—è',
      '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ –º–µ—Ç–æ–¥–∏ –∑–∞ –ø–æ–¥—Å–∏—Ä–≤–∞–Ω–µ –Ω–∞ —Å–∏—Ä–µ–Ω–µ'
    ],
    guides: [], // Will be determined by AI
  };

  // A simple logic to pick a more specific list if possible
  if (category === 'recipes') {
    if (clusterTitle.toLowerCase().includes('—Å–∏—Ä–µ–Ω–µ')) {
      return suggestions['recipes-cheese'];
    }
    if (clusterTitle.toLowerCase().includes('–∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ')) {
      return suggestions['recipes-yogurt'];
    }
  }

  return suggestions[category] || [];
}

// Slugify function for creating URL-friendly slugs
function slugify(text: string): string {
  // DEFENSIVE: Check for null/undefined
  if (!text || typeof text !== 'string') {
    console.error('[slugify] ‚ùå Received invalid input:', text, 'type:', typeof text);
    return 'invalid-slug';
  }

  const transliterationMap: { [key: string]: string } = {
    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '–∂': 'zh', '–∑': 'z',
    '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '–ø': 'p',
    '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch',
    '—à': 'sh', '—â': 'sht', '—ä': 'a', '—å': 'y', '—é': 'yu', '—è': 'ya',
    '–ê': 'A', '–ë': 'B', '–í': 'V', '–ì': 'G', '–î': 'D', '–ï': 'E', '–ñ': 'Zh', '–ó': 'Z',
    '–ò': 'I', '–ô': 'Y', '–ö': 'K', '–õ': 'L', '–ú': 'M', '–ù': 'N', '–û': 'O', '–ü': 'P',
    '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U', '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch',
    '–®': 'Sh', '–©': 'Sht', '–™': 'A', '–¨': 'Y', '–Æ': 'Yu', '–Ø': 'Ya'
  };

  return text
    .split('')
    .map(char => transliterationMap[char] || char)
    .join('')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

async function callOpenRouter(messages: any[], temperature = 0.7, maxTokens = 20000) {
  const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
      'Content-Type': 'application/json',
      'HTTP-Referer': 'https://www.bacho-iliya.eu',
      'X-Title': 'Bacho Iliya Learn Content Generator'
    },
    body: JSON.stringify({
      model: MODEL,
      messages,
      temperature,
      max_tokens: maxTokens,
    })
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`OpenRouter error ${response.status}: ${error}`);
  }

  const data = await response.json();
  return data.choices[0].message.content;
}

async function generateImage(prompt: string, slug: string): Promise<string | null> {
  const NANOBANANA_API_KEY = process.env.NANOBANANA_GEMINI_API_KEY;

  if (!NANOBANANA_API_KEY) {
    console.warn('[Image] NANOBANANA_GEMINI_API_KEY not found, skipping image generation');
    return null;
  }

  try {
    console.log('[Image] Generating with Gemini 2.5 Flash Image...');

    // Using Gemini Flash Image model via OpenRouter for image GENERATION
    const imageResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://www.bacho-iliya.eu',
        'X-Title': 'Bacho Iliya Image Generator'
      },
      body: JSON.stringify({
        model: 'google/gemini-2.5-flash-image',
        messages: [{
          role: 'user',
          content: prompt
        }],
        temperature: 0.8,
        max_tokens: 1000,
        // Image generation config for aspect ratio
        image_config: {
          aspect_ratio: '16:9' // Hero banner aspect ratio
        }
      })
    });

    if (!imageResponse.ok) {
      const errorText = await imageResponse.text();
      console.error('[Image] Generation failed:', errorText);
      return null;
    }

    const data = await imageResponse.json();
    console.log('[Image] Full response:', JSON.stringify(data, null, 2).substring(0, 500));

    // According to OpenRouter docs, images are in message.images array
    const message = data.choices[0]?.message;
    const images = message?.images;

    if (!images || images.length === 0) {
      console.error('[Image] No images in response');
      return null;
    }

    // Extract base64 data URL from first image
    const base64DataUrl = images[0]?.image_url?.url;

    if (!base64DataUrl || !base64DataUrl.startsWith('data:image')) {
      console.error('[Image] Invalid image format:', base64DataUrl?.substring(0, 100));
      return null;
    }

    console.log('[Image] Received base64 image, uploading to Supabase Storage...');

    // Extract base64 data (remove "data:image/png;base64," prefix)
    const base64Data = base64DataUrl.replace(/^data:image\/\w+;base64,/, '');
    const imageBuffer = Buffer.from(base64Data, 'base64');

    // Upload to Supabase Storage
    const fileName = `learn-guides/${slug}-${Date.now()}.png`;
    const supabase = supabaseAdmin;

    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('blog-images')
      .upload(fileName, imageBuffer, {
        contentType: 'image/png',
        cacheControl: '3600',
        upsert: false
      });

    if (uploadError) {
      console.error('[Image] Upload error:', uploadError);
      return null;
    }

    // Get public URL
    const { data: publicUrlData } = supabase.storage
      .from('blog-images')
      .getPublicUrl(fileName);

    const publicUrl = publicUrlData.publicUrl;
    console.log('[Image] Uploaded successfully:', publicUrl);

    return publicUrl;

  } catch (error) {
    console.error('[Image] Error:', error);
    return null;
  }
}

export async function POST(request: Request) {
  const supabase = supabaseAdmin;

  // Determine base URL for internal API calls
  const protocol = request.headers.get('x-forwarded-proto') || 'http';
  const host = request.headers.get('host') || 'localhost:3009';
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || `${protocol}://${host}`;

  try {
    const { title, category, keywords, mainTopic = 'dairy' } = await request.json();

    // Validate required fields
    if (!title) {
      return NextResponse.json(
        { error: 'Title is required' },
        { status: 400 }
      );
    }

    // Convert category to Bulgarian if it's an English slug
    const categoryBg = CATEGORY_LABELS[category] || category;

    // Check for duplicates using comprehensive duplicate detection API
    console.log('[Cluster] üîç About to call slugify with title:', title, 'type:', typeof title);
    const slug = slugify(title);

    console.log('[Cluster] Checking for duplicates using direct Supabase query...');

    // Direct duplicate check using Supabase (avoids fetch() in server-side)
    const { data: exactTitleMatch } = await supabase
      .from('blog_posts')
      .select('id, title, slug, category, guide_type, is_published')
      .eq('category', 'learn-guide')
      .ilike('title', title)
      .limit(1);

    const { data: exactSlugMatch } = await supabase
      .from('blog_posts')
      .select('id, title, slug, category, guide_type, is_published')
      .eq('category', 'learn-guide')
      .eq('slug', slug)
      .limit(1);

    const duplicateCheck = {
      hasDuplicates: (exactTitleMatch && exactTitleMatch.length > 0) || (exactSlugMatch && exactSlugMatch.length > 0),
      duplicates: {
        exactTitleMatch: exactTitleMatch || [],
        similarTitles: [],
        exactSlugMatch: exactSlugMatch || []
      }
    };

    if (duplicateCheck.hasDuplicates) {
      const { exactTitleMatch, similarTitles, exactSlugMatch } = duplicateCheck.duplicates;

      // Prepare error message
      let errorMessage = '‚ö†Ô∏è –û—Ç–∫—Ä–∏—Ç–∏ –¥—É–±–ª–∏—Ä–∞–Ω–∏—è:\n\n';

      if (exactTitleMatch.length > 0) {
        errorMessage += '‚ùå –ò–î–ï–ù–¢–ò–ß–ù–û –ó–ê–ì–õ–ê–í–ò–ï:\n';
        exactTitleMatch.forEach((post: any) => {
          errorMessage += `- "${post.title}" (${post.guide_type})\n`;
        });
      }

      if (exactSlugMatch.length > 0) {
        errorMessage += '\n‚ùå –ò–î–ï–ù–¢–ò–ß–ï–ù SLUG:\n';
        exactSlugMatch.forEach((post: any) => {
          errorMessage += `- "${post.title}" (/${post.slug})\n`;
        });
      }

      if (similarTitles.length > 0) {
        errorMessage += '\n‚ö†Ô∏è –ü–û–î–û–ë–ù–ò –ó–ê–ì–õ–ê–í–ò–Ø:\n';
        similarTitles.forEach((post: any) => {
          errorMessage += `- "${post.title}" (${post.guide_type})\n`;
        });
      }

      return NextResponse.json(
        {
          error: errorMessage,
          duplicate: true,
          duplicates: duplicateCheck.duplicates
        },
        { status: 409 }
      );
    }

    console.log('[Cluster] No duplicates found ‚úÖ');

    // Step 1: Check which pillars already exist (for smart linking)
    const { data: existingPillars } = await supabase
      .from('blog_posts')
      .select('title, slug')
      .eq('category', 'learn-guide')
      .eq('guide_type', 'pillar')
      .eq('guide_category', categoryBg);

    const existingPillarTitles = (existingPillars || []).map(p => p.title);

    // Step 2: Determine suggested pillars
    let suggestedPillars = getSuggestedPillars(category, title);

    // If category is "guides" or custom, ask AI to suggest pillars
    if (category === 'guides' || suggestedPillars.length === 0) {
      const aiSuggestionPrompt = [
        {
          role: 'system',
          content: `–¢–∏ —Å–∏ —Ä–æ–¥–µ–Ω –±—ä–ª–≥–∞—Ä–∏–Ω, –ï–ö–°–ü–ï–†–¢ –ø–æ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏, –±—ä–ª–≥–∞—Ä—Å–∫–∞ –∫—É—Ö–Ω—è, —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏ –∏ –∑–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–µ.

–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π —Ç–µ–º–∞—Ç–∞ –Ω–∞ cluster —Å—Ç–∞—Ç–∏—è—Ç–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ 4-8 –ö–û–ù–ö–†–ï–¢–ù–ò –ò –°–ü–ï–¶–ò–§–ò–ß–ù–ò pillar —Ç–µ–º–∏.

üî¥ –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–ù–û - –ï–°–¢–ï–°–¢–í–ï–ù –ë–™–õ–ì–ê–†–°–ö–ò –ï–ó–ò–ö:
- –ü–∏—à–∏ –Ω–∞ –†–û–î–ï–ù –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ (–ù–ï –±—É–∫–≤–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥–∏ –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏!)
- –ü—Ä–∞–≤–∏–ª–Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∞ –≥—Ä–∞–º–∞—Ç–∏–∫–∞ –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ —Ñ—Ä–∞–∑–∏, –∫–∞—Ç–æ —á–µ –≥–æ–≤–æ—Ä–∏—à —Å –ø—Ä–∏—è—Ç–µ–ª
- –ò–∑–±—è–≥–≤–∞–π –∏–∑–∫—É—Å—Ç–≤–µ–Ω–∏, –ø—Ä–µ–≤–µ–¥–µ–Ω–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

‚ùå –ó–ê–ë–†–ê–ù–ï–ù–ò –ì–†–ï–®–ö–ò:
- "–ü—ä—Ä–∂–µ–Ω–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ" ‚Üí –ü–†–ê–í–ò–õ–ù–û: "–ü—Ä–µ–ø–µ—á–µ–Ω–∏ —Ñ–∏–ª–∏–π–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ" –∏–ª–∏ "–ü—ä—Ä–∂–µ–Ω–∏ —Ñ–∏–ª–∏–π–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ"
- "–û—Å–Ω–æ–≤–∏ –Ω–∞ X" ‚Üí –ü–†–ê–í–ò–õ–ù–û: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ —è—Å—Ç–∏–µ –∏–ª–∏ –ø–æ–Ω—è—Ç–∏–µ
- "–ù–∞–ø—Ä–µ–¥–Ω–∞–ª–∏ —Ç–µ—Ö–Ω–∏–∫–∏" ‚Üí –ü–†–ê–í–ò–õ–ù–û: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —Ç–µ—Ö–Ω–∏–∫–∞ —Å –∏–º–µ
- –î—É–º–∏ —Å -ing —Ñ–æ—Ä–º–∏ ‚Üí –ü–†–ê–í–ò–õ–ù–û: –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∞–Ω–∞–ª–æ–∑–∏
- –ë—É–∫–≤–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏ —Ç–µ—Ä–º–∏–Ω–∏

‚ùå –õ–û–®–ò –ü–†–ò–ú–ï–†–ò (generic –∏–ª–∏ –±—É–∫–≤–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥–∏):
["–û—Å–Ω–æ–≤–∏ –Ω–∞ –∫–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ", "–ù–∞–ø—Ä–µ–¥–Ω–∞–ª–∏ —Ç–µ—Ö–Ω–∏–∫–∏", "–ü—ä—Ä–∂–µ–Ω–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ"]

‚úÖ –ü–†–ê–í–ò–õ–ù–ò –ü–†–ò–ú–ï–†–ò - –†–ï–¶–ï–ü–¢–ò:
Cluster: "–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ"
‚Üí ["–¢–∞—Ä–∞—Ç–æ—Ä - –∫–ª–∞—Å–∏—á–µ—Å–∫–∞—Ç–∞ —Ä–µ—Ü–µ–ø—Ç–∞", "–ú–ª–µ—á–Ω–∞ –±–∞–Ω–∏—Ü–∞ —Å—Ç—ä–ø–∫–∞ –ø–æ —Å—Ç—ä–ø–∫–∞", "–°–Ω–µ–∂–∞–Ω–∫–∞ (—Å–∞–ª–∞—Ç–∞ —Å —Ü–µ–¥–µ–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –∫—Ä–∞—Å—Ç–∞–≤–∏—Ü–∏, —á–µ—Å—ä–Ω –∏ –∫–æ–ø—ä—Ä)", "–ê–π—Ä—è–Ω - –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ –ª—è—Ç–Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞"]

Cluster: "–ü–µ—á–∏–≤–∞ –∏ —Å–ª–∞–¥–∫–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ"
‚Üí ["–ö–æ–∑—É–Ω–∞–∫ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –ø–æ –±–∞–±–∏–Ω–∞—Ç–∞ —Ä–µ—Ü–µ–ø—Ç–∞", "–ú–µ–∫–∏ –º–µ–∫–∏—Ü–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ", "–°–ª–∞–¥–∫–∏ –±–∞–Ω–∏—Ü–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ", "–ú–ª–µ—á–Ω–∞ –ø–∏—Ç–∞ —Å –∫—ä–¥—Ä–∏—Ü–∏"]

‚úÖ –ü–†–ê–í–ò–õ–ù–ò –ü–†–ò–ú–ï–†–ò - –ó–î–†–ê–í–ï:
Cluster: "–ó–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–∏ –ø–æ–ª–∑–∏ –æ—Ç –∫–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ"
‚Üí ["–ö–∞–∫ –ø—Ä–æ–±–∏–æ—Ç–∏—Ü–∏—Ç–µ –ø–æ–º–∞–≥–∞—Ç –Ω–∞ —Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞–Ω–µ—Ç–æ", "–ö–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –∑–∞ —Å–∏–ª–µ–Ω –∏–º—É–Ω–∏—Ç–µ—Ç", "–ö–∞–ª—Ü–∏–π –æ—Ç –º–ª–µ—á–Ω–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏", "–ó–∞—â–æ –∫–∏—Å–µ–ª–æ—Ç–æ –º–ª—è–∫–æ –µ –ø–æ–ª–µ–∑–Ω–æ –∑–∞ —Å—Ç–æ–º–∞—Ö–∞"]

‚úÖ –ü–†–ê–í–ò–õ–ù–ò –ü–†–ò–ú–ï–†–ò - –ü–†–û–î–£–ö–¢–ò:
Cluster: "–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏"
‚Üí ["–ë—ä–ª–≥–∞—Ä—Å–∫–æ—Ç–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ - —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–æ", "–ë—è–ª–æ—Ç–æ —Å–∞–ª–∞–º—É—Ä–µ–Ω–æ —Å–∏—Ä–µ–Ω–µ", "–ò–∑–≤–∞—Ä–∞ - –∑–∞–±—Ä–∞–≤–µ–Ω–∏—è—Ç –¥–µ–ª–∏–∫–∞—Ç–µ—Å", "–ö–∞—Ç—ä–∫ - –≥—ä—Å—Ç–æ—Ç–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ"]

**–í–ê–ñ–ù–û –ü–†–ê–í–ò–õ–û –ó–ê –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢:** –ö–æ–≥–∞—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞—à Cluster –Ω–∞ —Ç–µ–º–∞ '–∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ', –∏–∑–ø–æ–ª–∑–≤–∞–π –°–ê–ú–û —Ä–µ—Ü–µ–ø—Ç–∏ –æ—Ç —Å–ø–∏—Å—ä–∫–∞ '–†–ï–¶–ï–ü–¢–ò –° –ö–ò–°–ï–õ–û –ú–õ–Ø–ö–û'. –ö–æ–≥–∞—Ç–æ —Ç–µ–º–∞—Ç–∞ –µ '—Å–∏—Ä–µ–Ω–µ', –∏–∑–ø–æ–ª–∑–≤–∞–π –°–ê–ú–û —Ä–µ—Ü–µ–ø—Ç–∏ –æ—Ç —Å–ø–∏—Å—ä–∫–∞ '–†–ï–¶–ï–ü–¢–ò –°–™–° –°–ò–†–ï–ù–ï'. –ù–ï –°–ú–ï–°–í–ê–ô –†–ï–¶–ï–ü–¢–ò –û–¢ –†–ê–ó–õ–ò–ß–ù–ò –°–ü–ò–°–™–¶–ò!

üîµ –†–ï–ê–õ–ù–ò –ë–™–õ–ì–ê–†–°–ö–ò –†–ï–¶–ï–ü–¢–ò (–∏–∑–ø–æ–ª–∑–≤–∞–π –°–ê–ú–û —Ç–µ–∑–∏):
–ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ: —Ç–∞—Ä–∞—Ç–æ—Ä –∫–ª–∞—Å–∏—á–µ—Å–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞, —Å–Ω–µ–∂–∞–Ω–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞, —è–π—Ü–∞ –ø–æ –ø–∞–Ω–∞–≥—é—Ä—Å–∫–∏, –∫–µ–∫—Å —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –¥–µ—Å–µ—Ä—Ç —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, —Å–æ–¥–µ–Ω–∫–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –∫–∞—Ç–º–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ
–°–∏—Ä–µ–Ω–µ: –±–∞–Ω–∏—Ü–∞ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –±—ä—Ä–∑–∞ –±–∞–Ω–∏—Ü–∞ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –ø—ä–ª–Ω–µ–Ω–∏ —á—É—à–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –∏ —è–π—Ü–µ, —Å–∏—Ä–µ–Ω–µ –ø–æ —à–æ–ø—Å–∫–∏, –º–∏—à –º–∞—à —Ä–µ—Ü–µ–ø—Ç–∞, –∫–∞—Ä—Ç–æ—Ñ–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –Ω–∞ —Ñ—É—Ä–Ω–∞, –±—É—Ö—Ç–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, —Å–æ–ª–µ–Ω –∫–µ–∫—Å —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –ø—ä—Ä–∂–µ–Ω–∏ —Ñ–∏–ª–∏–π–∫–∏ —Å —è–π—Ü–µ –∏ —Å–∏—Ä–µ–Ω–µ
–î–µ—Å–µ—Ä—Ç–∏: –º–ª–µ—á–Ω–∞ –±–∞–Ω–∏—Ü–∞ —Ä–µ—Ü–µ–ø—Ç–∞, —Å–ª–∞–¥–∫–∏—à —Å –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ, –∫—Ä–µ–º –∫–∞—Ä–∞–º–µ–ª —Ä–µ—Ü–µ–ø—Ç–∞, –¥–æ–º–∞—à–µ–Ω –º–ª–µ—á–µ–Ω –∫—Ä–µ–º, –≥—Ä–∏—Å —Ö–∞–ª–≤–∞ —Å –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ, –ø–∞–ª–∞—á–∏–Ω–∫–∏ —Å –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ
–ê–π—Ä—è–Ω: –∫–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ –∞–π—Ä—è–Ω, —Å—Ç—É–¥–µ–Ω–∞ —Å—É–ø–∞ —Å –∞–π—Ä—è–Ω, —Ä–µ—Ü–µ–ø—Ç–∞ –∑–∞ –∞–π—Ä—è–Ω
–ò–∑–≤–∞—Ä–∞/–ö–∞—Ç—ä–∫: —Ä–µ—Ü–µ–ø—Ç–∏ —Å –∏–∑–≤–∞—Ä–∞, —Å–ª–∞–¥–∫–∏—à —Å –∏–∑–≤–∞—Ä–∞, –∫–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ –∫–∞—Ç—ä–∫, —Ä–µ—Ü–µ–ø—Ç–∞ –∑–∞ –∫–∞—Ç—ä–∫, –∫–∞—Ç—ä–∫ —Å —á–µ—Å—ä–Ω –∏ –æ—Ä–µ—Ö–∏
–†–µ–≥–∏–æ–Ω–∞–ª–Ω–∏: –∫–∞—á–∞–º–∞–∫ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, —Ç–∞—Ä–∞—Ç–æ—Ä –ø–æ —Å–µ–ª—Å–∫–∏, —Ä–æ–¥–æ–ø—Å–∫–∏ –∫–ª–∏–Ω —Ä–µ—Ü–µ–ø—Ç–∞, –ø–∞—Ç–∞—Ç–Ω–∏–∫ —Ä–µ—Ü–µ–ø—Ç–∞, –º–µ–∫–∏—Ü–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –∏ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ

–ü–†–ê–í–ò–õ–û: –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –¢–ï–ú–ê–¢–ê –≤–Ω–∏–º–∞—Ç–µ–ª–Ω–æ –∏ –∏–∑–ø–æ–ª–∑–≤–∞–π –°–ê–ú–û –≥–æ—Ä–Ω–∏—Ç–µ —Ä–µ–∞–ª–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏ –∑–∞ pillars!

–í—ä—Ä–Ω–∏ –°–ê–ú–û –≤–∞–ª–∏–¥–µ–Ω JSON array —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –ë–™–õ–ì–ê–†–°–ö–ò —Ç–µ–º–∏ (–ë–ï–ó –±—É–∫–≤–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥–∏):
["–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∞ —Ç–µ–º–∞ 1", "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∞ —Ç–µ–º–∞ 2", ...]`
        },
        {
          role: 'user',
          content: `Cluster —Ç–µ–º–∞: "${title}"
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}
Keywords: ${keywords || '–Ω—è–º–∞'}

–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π —Ç–µ–º–∞—Ç–∞ –≤–Ω–∏–º–∞—Ç–µ–ª–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ 4-8 –ö–û–ù–ö–†–ï–¢–ù–ò pillar —Ç–µ–º–∏ –∫–æ–∏—Ç–æ —è –¥–æ–ø—ä–ª–≤–∞—Ç.`
        }
      ];

      let aiResponse = await callOpenRouter(aiSuggestionPrompt, 0.8, 1000);
      console.log('[AI Pillar Suggestions] Raw AI response:', aiResponse);

      // Clean up markdown code fences
      aiResponse = aiResponse.trim();
      if (aiResponse.startsWith('```json')) {
        aiResponse = aiResponse.replace(/^```json\s*/, '').replace(/\s*```$/, '');
      } else if (aiResponse.startsWith('```')) {
        aiResponse = aiResponse.replace(/^```\s*/, '').replace(/\s*```$/, '');
      }

      try {
        suggestedPillars = JSON.parse(aiResponse);
        console.log('[AI Pillar Suggestions] ‚úÖ Parsed:', suggestedPillars.length, 'pillars');
      } catch (e) {
        console.error('[AI Pillar Suggestions] ‚ùå JSON parse failed:', e);
        suggestedPillars = [];
      }
    }

    // Step 3: Generate cluster content
    const contentPrompt = [
      {
        role: 'system',
        content: `–¢–∏ —Å–∏ –ï–ö–°–ü–ï–†–¢–ï–ù –ø–∏—Å–∞—Ç–µ–ª –Ω–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–Ω–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ –∑–∞ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∏ –±—ä–ª–≥–∞—Ä—Å–∫–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞ –∫—É—Ö–Ω—è. –ü–∏—à–µ—à –Ω–∞ –ø–µ—Ä—Ñ–µ–∫—Ç–µ–Ω –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫.

–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–ù–û - –ë–™–õ–ì–ê–†–°–ö–ò –ï–ó–ò–ö:
- –ü–∏—à–∏ –Ω–∞ –ï–°–¢–ï–°–¢–í–ï–ù –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ (–ù–ï –±—É–∫–≤–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥–∏!)
- –ì—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–µ–Ω –±—ä–ª–≥–∞—Ä—Å–∫–∏
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω, –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ–Ω —Ç–æ–Ω
- –ö–∞—Ç–æ —á–µ –≥–æ–≤–æ—Ä–∏—à —Å –ø—Ä–∏—è—Ç–µ–ª –∑–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—Ç–∞ –Ω–∏ –∫—É—Ö–Ω—è

–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–ù–û - –ó–ê–ë–†–ê–ù–ï–ù–ò –ù–ï–©–ê:

‚ùå –ê–ë–°–û–õ–Æ–¢–ù–û –ó–ê–ë–†–ê–ù–ï–ù–û:
- –ù–ò–ö–ê–ö–í–ò –µ–º–æ—Ç–∏–∫–æ–Ω–∏ –≤ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∑–∞–≥–ª–∞–≤–∏—è—Ç–∞ (üìù, ‚ú®, ü•õ, üßÄ, üç≤, ü§ñ, ‚úÖ, üìã, üìñ, üìö)
- –ù–ò–ö–ê–ö–í–ò –∏–∑–º–∏—Å–ª–µ–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏ (–ú–∞–π–æ–Ω–µ–∑–∞ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –ö—Ä–µ–º –∫–∞—Ä–∞–º–µ–ª —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ)
- –ù–ò–ö–ê–ö–í–ò –Ω–µ—Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (–®–æ–ø—Å–∫–∞ —Å–∞–ª–∞—Ç–∞ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ)
- –ù–ò–ö–ê–ö–í–ò –±—É–∫–≤–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥–∏ –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏ (–ü—ä—Ä–∂–µ–Ω–∫–∏, French toast, –∏ –¥—Ä.)
- –ù–ï –∏–∑–ø–æ–ª–∑–≤–∞–π –¥—É–º–∏ —Å -ing —Ñ–æ—Ä–º–∏ –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏ —Ç–µ—Ä–º–∏–Ω–∏
- H1 —Ç–∞–≥–æ–≤–µ
- H2 —Å—ä—Å –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ (template-—ä—Ç –≤–µ—á–µ –≥–æ –ø–æ–∫–∞–∑–≤–∞!)
- <article>, <header>, <footer> —Ç–∞–≥–æ–≤–µ
- Complex grids, cards, sections

‚úÖ –ò–ó–ò–°–ö–í–ê–ù–ò–Ø –ó–ê –ï–ó–ò–ö:
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω —Ä–æ–¥–µ–Ω –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫
- –ü—Ä–∞–≤–∏–ª–Ω–∞ –≥—Ä–∞–º–∞—Ç–∏–∫–∞ –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞
- –ö–∞—Ç–æ —á–µ –≥–æ–≤–æ—Ä–∏—à —Å –ø—Ä–∏—è—Ç–µ–ª –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ –∫—É—Ö–Ω—è
- –ò–∑–ø–æ–ª–∑–≤–∞–π —Å–∞–º–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ —è—Å—Ç–∏—è –∏ –ø—Ä–æ–¥—É–∫—Ç–∏

üîµ –†–ï–ê–õ–ù–ò –ë–™–õ–ì–ê–†–°–ö–ò –†–ï–¶–ï–ü–¢–ò –ò –¢–ï–†–ú–ò–ù–ò (–∏–∑–ø–æ–ª–∑–≤–∞–π –°–ê–ú–û —Ç–µ–∑–∏):

–†–ï–¶–ï–ü–¢–ò –° –ö–ò–°–ï–õ–û –ú–õ–Ø–ö–û:
—Ç–∞—Ä–∞—Ç–æ—Ä –∫–ª–∞—Å–∏—á–µ—Å–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞, —Å–Ω–µ–∂–∞–Ω–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞, —è–π—Ü–∞ –ø–æ –ø–∞–Ω–∞–≥—é—Ä—Å–∫–∏, –∫–µ–∫—Å —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –¥–µ—Å–µ—Ä—Ç —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, —Å–æ–¥–µ–Ω–∫–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –∫–∞—Ç–º–∏ —Å –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ

–†–ï–¶–ï–ü–¢–ò –°–™–° –°–ò–†–ï–ù–ï:
–±–∞–Ω–∏—Ü–∞ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –±—ä—Ä–∑–∞ –±–∞–Ω–∏—Ü–∞ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –ø—ä–ª–Ω–µ–Ω–∏ —á—É—à–∫–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –∏ —è–π—Ü–µ, —Å–∏—Ä–µ–Ω–µ –ø–æ —à–æ–ø—Å–∫–∏, –º–∏—à –º–∞—à —Ä–µ—Ü–µ–ø—Ç–∞, –∫–∞—Ä—Ç–æ—Ñ–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –Ω–∞ —Ñ—É—Ä–Ω–∞, –±—É—Ö—Ç–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, —Å–æ–ª–µ–Ω –∫–µ–∫—Å —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –ø—ä—Ä–∂–µ–Ω–∏ —Ñ–∏–ª–∏–π–∫–∏ —Å —è–π—Ü–µ –∏ —Å–∏—Ä–µ–Ω–µ

–î–ï–°–ï–†–¢–ò:
–º–ª–µ—á–Ω–∞ –±–∞–Ω–∏—Ü–∞ —Ä–µ—Ü–µ–ø—Ç–∞, —Å–ª–∞–¥–∫–∏—à —Å –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ, –∫—Ä–µ–º –∫–∞—Ä–∞–º–µ–ª —Ä–µ—Ü–µ–ø—Ç–∞, –¥–æ–º–∞—à–µ–Ω –º–ª–µ—á–µ–Ω –∫—Ä–µ–º, –≥—Ä–∏—Å —Ö–∞–ª–≤–∞ —Å –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ, –ø–∞–ª–∞—á–∏–Ω–∫–∏ —Å –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ

–ê–ô–†–Ø–ù:
–∫–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ –∞–π—Ä—è–Ω, —Å—Ç—É–¥–µ–Ω–∞ —Å—É–ø–∞ —Å –∞–π—Ä—è–Ω, —Ä–µ—Ü–µ–ø—Ç–∞ –∑–∞ –∞–π—Ä—è–Ω, —Å–æ–ª–µ–Ω –∞–π—Ä—è–Ω

–ò–ó–í–ê–†–ê/–ö–ê–¢–™–ö:
—Ä–µ—Ü–µ–ø—Ç–∏ —Å –∏–∑–≤–∞—Ä–∞, —Å–ª–∞–¥–∫–∏—à —Å –∏–∑–≤–∞—Ä–∞, –∫–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ –∫–∞—Ç—ä–∫, —Ä–µ—Ü–µ–ø—Ç–∞ –∑–∞ –∫–∞—Ç—ä–∫, –∫–∞—Ç—ä–∫ —Å —á–µ—Å—ä–Ω –∏ –æ—Ä–µ—Ö–∏, –∏–∑–≤–∞—Ä–∞ –ø—Ä–æ—Ç–µ–∏–Ω, –∏–∑–≤–∞—Ä–∞ –∑–∞ —Ñ–∏—Ç–Ω–µ—Å

–†–ï–ì–ò–û–ù–ê–õ–ù–ò:
–∫–∞—á–∞–º–∞–∫ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, —Ç–∞—Ä–∞—Ç–æ—Ä –ø–æ —Å–µ–ª—Å–∫–∏, —Ä–æ–¥–æ–ø—Å–∫–∏ –∫–ª–∏–Ω —Ä–µ—Ü–µ–ø—Ç–∞, –ø–∞—Ç–∞—Ç–Ω–∏–∫ —Ä–µ—Ü–µ–ø—Ç–∞, –º–µ–∫–∏—Ü–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ –∏ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, —Ä–æ–¥–æ–ø—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, —Ä–æ–¥–æ–ø—Å–∫–æ —Å–∏—Ä–µ–Ω–µ

–ó–î–†–ê–í–û–°–õ–û–í–ù–ò –¢–ï–†–ú–ò–ù–ò:
–ø—Ä–æ–±–∏–æ—Ç–∏—Ü–∏, –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –ø—Ä–æ–±–∏–æ—Ç–∏—Ü–∏, –º–ª–µ—á–Ω–æ–∫–∏—Å–µ–ª–∏ –±–∞–∫—Ç–µ—Ä–∏–∏, –ª–∞–∫—Ç–æ–±–∞—Ü–∏–ª–∏, –∑–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–æ —Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞–Ω–µ, –±–µ–∑ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–∏, –ø—Ä–æ—Ç–µ–∏–Ω–∏, —Ö—Ä–∞–Ω–∏ –±–æ–≥–∞—Ç–∏ –Ω–∞ –∫–∞–ª—Ü–∏–π

–ë–†–ê–ù–î –¢–ï–†–ú–ò–ù–ò:
–∏—Å—Ç–∏–Ω—Å–∫–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏, –Ω–∞—Ç—É—Ä–∞–ª–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ –±–µ–∑ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–∏, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ, —Ñ–µ—Ä–º–µ—Ä—Å–∫–∏ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏, –∑–∞–Ω–∞—è—Ç—á–∏–π—Å–∫–æ —Å–∏—Ä–µ–Ω–µ, –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –ø–æ –ë–î–°, —Å–∏—Ä–µ–Ω–µ –ø–æ –ë–î–°, –±–∞–±–∏–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ, –¥–æ–º–∞—à–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ —Ä–µ—Ü–µ–ø—Ç–∞

üéØ BRAND POSITIONING - –ë–ê–ß–û –ò–õ–ò–Ø (–í–ê–ñ–ù–û: –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ, –ù–ï –°–ü–ê–ú):

–ö–ê–ö–í–û –ï –ë–ê–ß–û –ò–õ–ò–Ø:
- –°–µ–º–µ–π–Ω–∞ —Ñ–∏—Ä–º–∞ —Å 30+ –≥–æ–¥–∏–Ω–∏ —Ç—Ä–∞–¥–∏—Ü–∏—è (–æ—Å–Ω–æ–≤–∞–Ω–∞ 1990-—Ç–µ)
- –ò—Å—Ç–∏–Ω—Å–∫–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª –Ω–∞ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏
- –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏, –ø—Ä–µ–¥–∞–≤–∞–Ω–∏ –æ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏—è
- –ë–µ–∑ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–∏ –∏ –∏–∑–∫—É—Å—Ç–≤–µ–Ω–∏ –¥–æ–±–∞–≤–∫–∏
- –ö–∞—á–µ—Å—Ç–≤–µ–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ –∏ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ

–ö–ê–ö –î–ê –°–ü–û–ú–ï–ù–ê–í–ê–® –ë–ê–ß–û –ò–õ–ò–Ø (1-2 –ø—ä—Ç–∏ –Ω–∞ —Å—Ç–∞—Ç–∏—è MAX):
‚úÖ –ü–†–ê–í–ò–õ–ù–û - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ:
- "–ó–∞ –ø—Ä–∏–≥–æ—Ç–≤—è–Ω–µ—Ç–æ –Ω–∞ —Ç–∞—Ä–∞—Ç–æ—Ä–∞ –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –∫–∞—Ç–æ –ë–∞—á–æ –ò–ª–∏—è"
- "–ò—Å—Ç–∏–Ω—Å–∫–æ—Ç–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ –±–µ–∑ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–∏ (–∫–∞—Ç–æ –ë–∞—á–æ –ò–ª–∏—è) –∏–º–∞ –∞–≤—Ç–µ–Ω—Ç–∏—á–µ–Ω –≤–∫—É—Å"
- "–ó–∞ –∞–≤—Ç–µ–Ω—Ç–∏—á–Ω–∞ –±–∞–Ω–∏—Ü–∞ –∏–∑–±–µ—Ä–µ—Ç–µ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ –ø–æ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞ —Ä–µ—Ü–µ–ø—Ç–∞ –∫–∞—Ç–æ –ë–∞—á–æ –ò–ª–∏—è"
- "–ö–∞—á–µ—Å—Ç–≤–µ–Ω–æ—Ç–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ –∫–∞—Ç–æ –ë–∞—á–æ –ò–ª–∏—è –µ –∫–ª—é—á—ä—Ç –∫—ä–º –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–∏—è —Ç–∞—Ä–∞—Ç–æ—Ä"

‚ùå –ì–†–ï–®–ù–û - —Å–ø–∞–º –∏–ª–∏ –∞–≥—Ä–µ—Å–∏–≤–Ω–æ:
- "–ë–∞—á–æ –ò–ª–∏—è –µ –Ω–∞–π-–¥–æ–±—Ä–æ—Ç–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ" (—Ç–≤—ä—Ä–¥–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ, –∏–∑–≥–ª–µ–∂–¥–∞ –∫–∞—Ç–æ —Ä–µ–∫–ª–∞–º–∞)
- –°–ø–æ–º–µ–Ω–∞–≤–∞–Ω–µ –Ω–∞ –ë–∞—á–æ –ò–ª–∏—è 5+ –ø—ä—Ç–∏ (–°–ü–ê–ú)
- "–°–∞–º–æ –ë–∞—á–æ –ò–ª–∏—è –ø—Ä–∞–≤–∏ –∏—Å—Ç–∏–Ω—Å–∫–æ —Å–∏—Ä–µ–Ω–µ" (—Ç–≤—ä—Ä–¥–µ –∞–≥—Ä–µ—Å–∏–≤–Ω–æ)
- –°–ø–æ–º–µ–Ω–∞–≤–∞–Ω–µ –Ω–∞ –ö–û–ù–ö–£–†–ï–ù–¢–ò (–ù–ï —Å–ø–æ–º–µ–Ω–∞–≤–∞–π –ú–∞–¥–∂–∞—Ä–æ–≤, –õ–ë –ë—É–ª–≥–∞—Ä–∏–∫—É–º, –í–µ—Ä–µ—è –∏ –¥—Ä.)

–ê–õ–¢–ï–†–ù–ê–¢–ò–í–ò (–≤–º–µ—Å—Ç–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∏):
- "–∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ" (–æ–±—â–æ)
- "–∞–≤—Ç–µ–Ω—Ç–∏—á–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏" (–æ–±—â–æ)
- "–ø—Ä–æ–≤–µ—Ä–µ–Ω–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏" (–æ–±—â–æ)
- "—Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ" (–æ–±—â–æ)

‚úÖ –†–ê–ó–†–ï–®–ï–ù–û:
- <p> –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∏
- <h2> –∏ <h3> –∑–∞–≥–ª–∞–≤–∏—è (–ë–ï–ó –µ–º–æ—Ç–∏–∫–æ–Ω–∏!)
- <ul>, <li> —Å–ø–∏—Å—ä—Ü–∏
- <a href="/blog/learn/SLUG"> internal links
- <strong> –∑–∞ emphasis
- <div class="tldr-section"> –∑–∞ —Ä–µ–∑—é–º–µ—Ç–∞
- <table> —Ç–∞–±–ª–∏—Ü–∏ (–ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–û –≤–∫–ª—é—á–∏ –ø–æ–Ω–µ 1-2 —Ç–∞–±–ª–∏—Ü–∏!)

–¢–ê–ë–õ–ò–¶–ò (responsive, –ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–û –∏–∑–ø–æ–ª–∑–≤–∞–π):
<div class="overflow-x-auto my-6">
  <table class="min-w-full border-collapse border border-zinc-300">
    <thead>
      <tr class="bg-zinc-100">
        <th class="border border-zinc-300 px-4 py-2 text-left font-semibold">–ö–æ–ª–æ–Ω–∞ 1</th>
        <th class="border border-zinc-300 px-4 py-2 text-left font-semibold">–ö–æ–ª–æ–Ω–∞ 2</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="border border-zinc-300 px-4 py-2">–î–∞–Ω–Ω–∏</td>
        <td class="border border-zinc-300 px-4 py-2">–î–∞–Ω–Ω–∏</td>
      </tr>
    </tbody>
  </table>
</div>

–ü–†–ò–ú–ï–†–ò –ó–ê –¢–ê–ë–õ–ò–¶–ò:
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –≤–∏–¥–æ–≤–µ —Å–∏—Ä–µ–Ω–µ (–æ–≤—á–µ, –∫—Ä–∞–≤–µ, –∫–æ–∑–µ)
- –•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ 100–≥ –ø—Ä–æ–¥—É–∫—Ç
- –í—Ä–µ–º–µ–Ω–∞ –∑–∞ –ø—Ä–∏–≥–æ—Ç–≤—è–Ω–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ vs. —Å—ä–≤—Ä–µ–º–µ–Ω–Ω–∏ –º–µ—Ç–æ–¥–∏

SPACING –ò –§–û–†–ú–ê–¢–ò–†–ê–ù–ï:
- –î–æ–±–∞–≤–∏ spacing –º–µ–∂–¥—É —Å–µ–∫—Ü–∏–∏ —Å –ø—Ä–∞–∑–Ω–∏ —Ä–µ–¥–æ–≤–µ
- –ò–∑–ø–æ–ª–∑–≤–∞–π <h2> –∑–∞ –≥–ª–∞–≤–Ω–∏ —Å–µ–∫—Ü–∏–∏ (—Å –≥–æ–ª—è–º —à—Ä–∏—Ñ—Ç)
- –ò–∑–ø–æ–ª–∑–≤–∞–π <h3> –∑–∞ –ø–æ–¥—Å–µ–∫—Ü–∏–∏
- –ì—Ä—É–ø–∏—Ä–∞–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏
- –í—Å–µ–∫–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –¥–∞ –µ 3-5 –∏–∑—Ä–µ—á–µ–Ω–∏—è

–°–¢–†–£–ö–¢–£–†–ê –ù–ê CLUSTER –°–¢–ê–¢–ò–Ø (3,500 –¥—É–º–∏):

1. TLDR —Å–µ–∫—Ü–∏—è –≤ –Ω–∞—á–∞–ª–æ—Ç–æ:
   <div class="tldr-section">
     <h3>–ö–ª—é—á–æ–≤–∏ –º–æ–º–µ–Ω—Ç–∏</h3>
     <p>–û–±–æ–±—â–µ–Ω–∏–µ –≤ 3-4 –∏–∑—Ä–µ—á–µ–Ω–∏—è...</p>
   </div>

2. TABLE OF CONTENTS (–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ë–ï–ó –µ–º–æ—Ç–∏–∫–æ–Ω–∏):
   <div class="toc-section my-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
     <h3 class="text-2xl font-bold mb-4">–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ</h3>
     <ol class="space-y-2 list-decimal list-inside">
       <li><a href="#section-1" class="text-blue-600 hover:underline">–û–±—â –ø—Ä–µ–≥–ª–µ–¥</a></li>
       <li><a href="#section-2" class="text-blue-600 hover:underline">–û—Å–Ω–æ–≤–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏</a></li>
       <li><a href="#section-3" class="text-blue-600 hover:underline">–ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ</a></li>
       <li><a href="#section-4" class="text-blue-600 hover:underline">–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</a></li>
       <li><a href="#section-5" class="text-blue-600 hover:underline">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ</a></li>
     </ol>
   </div>

3. –í—ä–≤–µ–¥–µ–Ω–∏–µ (300 –¥—É–º–∏) - –î–∏—Ä–µ–∫—Ç–Ω–æ <p> –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∏ –ë–ï–ó H2 –∑–∞–≥–ª–∞–≤–∏–µ!
4. –û–±—â –ø—Ä–µ–≥–ª–µ–¥ (500 –¥—É–º–∏) - <h2 id="section-1">–û–±—â –ø—Ä–µ–≥–ª–µ–¥</h2>
5. –û—Å–Ω–æ–≤–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ (800 –¥—É–º–∏) - <h2 id="section-2">–û—Å–Ω–æ–≤–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏</h2>
6. –ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ (1000 –¥—É–º–∏) - <h2 id="section-3">–ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ</h2> - –°–ø–æ–º–µ–Ω–∞–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ ${suggestedPillars.length} pillar —Ç–µ–º–∏
7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (500 –¥—É–º–∏) - <h2 id="section-4">–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
8. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (400 –¥—É–º–∏) - <h2 id="section-5">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ</h2>

–í–ê–ñ–ù–û: –í—Å–µ–∫–∏ H2 —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ id –∞—Ç—Ä–∏–±—É—Ç (id="section-1", id="section-2" –∏ —Ç.–Ω.) –∑–∞ –¥–∞ —Ä–∞–±–æ—Ç—è—Ç –ª–∏–Ω–∫–æ–≤–µ—Ç–µ –≤ Table of Contents!

SMART INTERNAL LINKING:
${(existingPillars || []).length > 0 ? `–°–™–©–ï–°–¢–í–£–í–ê–©–ò –¢–ï–ú–ò (–¥–æ–±–∞–≤–∏ –ª–∏–Ω–∫–æ–≤–µ):
${(existingPillars || []).map((p, i) => `${i + 1}. "${p.title}" ‚Üí <a href="/blog/learn/${p.slug}">${p.title}</a>`).join('\n')}` : '–ù–Ø–ú–ê —Å—ä–∑–¥–∞–¥–µ–Ω–∏ pillar —Ç–µ–º–∏ –æ—â–µ.'}

${(existingPillars || []).length < suggestedPillars.length ? `–ü–õ–ê–ù–ò–†–ê–ù–ò –¢–ï–ú–ò (–ù–ï —Å–ª–∞–≥–∞–π –ª–∏–Ω–∫–æ–≤–µ, —Å–∞–º–æ —Å–ø–æ–º–µ–Ω–∞–π):
${suggestedPillars.filter(sp => !existingPillarTitles.includes(sp)).map((p, i) => `${i + 1}. "${p}" ‚Üí —Å–ø–æ–º–µ–Ω–∞–π –ë–ï–ó –ª–∏–Ω–∫`).join('\n')}` : ''}

üîó CROSS-CONTENT LINKING (–í–ê–ñ–ù–û - –¥–æ–±–∞–≤—è–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ):

–ü–†–û–î–£–ö–¢–ò –ë–ê–ß–û –ò–õ–ò–Ø (–¥–æ–±–∞–≤–∏ –ª–∏–Ω–∫–æ–≤–µ –∫—ä–¥–µ—Ç–æ –µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ):
- –ë—è–ª–æ —Å–∏—Ä–µ–Ω–µ ‚Üí <a href="/products/byalo-sirene">–ë—è–ª–æ —Å–∏—Ä–µ–Ω–µ –ë–∞—á–æ –ò–ª–∏—è</a>
- –ö–∞—à–∫–∞–≤–∞–ª ‚Üí <a href="/products/kashkaval">–ö–∞—à–∫–∞–≤–∞–ª –ë–∞—á–æ –ò–ª–∏—è</a>
- –ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ (–æ–±—â–æ) ‚Üí <a href="/products/kiselo-mlyako-3-6">–ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ –ë–∞—á–æ –ò–ª–∏—è</a>
- –ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ 2% ‚Üí <a href="/products/kiselo-mlyako-2">–ù–∏—Å–∫–æ–º–∞—Å–ª–µ–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ 2%</a>
- –ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ 3.6% ‚Üí <a href="/products/kiselo-mlyako-3-6">–ö–ª–∞—Å–∏—á–µ—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ 3.6%</a>
- –ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ 4.5% ‚Üí <a href="/products/kiselo-mlyako-4-5">–ü—ä–ª–Ω–æ–º–∞—Å–ª–µ–Ω–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ 4.5%</a>
- –ê–π—Ä—è–Ω ‚Üí <a href="/products/ayran">–ê–π—Ä—è–Ω –ë–∞—á–æ –ò–ª–∏—è</a>
- –ü—Ä–æ—Ç–µ–∏–Ω–æ–≤–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ ‚Üí <a href="/products/protein-kiselo-mlyako">–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ</a>

–†–ï–¶–ï–ü–¢–ò (–¥–æ–±–∞–≤–∏ –ª–∏–Ω–∫–æ–≤–µ –∫—ä–¥–µ—Ç–æ —Å–ø–æ–º–µ–Ω–∞–≤–∞—à):
- –ë–∞–Ω–∏—Ü–∞ ‚Üí <a href="/recipes/traditional-banitsa">–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞ –±–∞–Ω–∏—Ü–∞ —Å—ä—Å —Å–∏—Ä–µ–Ω–µ</a>
- –ú–ª–µ—á–Ω–∞ –±–∞–Ω–∏—Ü–∞ ‚Üí <a href="/recipes/mlechna-banica">–ú–ª–µ—á–Ω–∞ –±–∞–Ω–∏—Ü–∞</a>
- –®–æ–ø—Å–∫–∞ —Å–∞–ª–∞—Ç–∞ ‚Üí <a href="/recipes/shopska-salad-classic">–®–æ–ø—Å–∫–∞ —Å–∞–ª–∞—Ç–∞</a>
- –¢–∞—Ä–∞—Ç–æ—Ä/–°–Ω–µ–∂–∞–Ω–∫–∞ ‚Üí <a href="/recipes/snezhanka-tarator-combo">–¢–∞—Ä–∞—Ç–æ—Ä –∏ –°–Ω–µ–∂–∞–Ω–∫–∞</a>
- –ü–∞–Ω–∏—Ä–∞–Ω–æ –∫–∞—à–∫–∞–≤–∞–ª ‚Üí <a href="/recipes/kashkaval-pane">–ü–∞–Ω–∏—Ä–∞–Ω–æ –∫–∞—à–∫–∞–≤–∞–ª</a>
- –ú–∏—à-–º–∞—à ‚Üí <a href="/recipes/mish-mash-traditional">–ú–∏—à-–º–∞—à</a>
- –ú—É—Å–∞–∫–∞ ‚Üí <a href="/recipes/musaka-classic">–ë—ä–ª–≥–∞—Ä—Å–∫–∞ –º—É—Å–∞–∫–∞</a>

–ú–ê–ì–ê–ó–ò–ù–ò:
- –ö—ä–¥–µ –¥–∞ –∫—É–ø–∏—à/–ù–∞–º–µ—Ä–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–∞ ‚Üí <a href="/where-to-buy">–ö—ä–¥–µ –¥–∞ –∫—É–ø–∏—à –ë–∞—á–æ –ò–ª–∏—è</a>

–ü–†–ê–í–ò–õ–ê –ó–ê LINKING:
- –î–æ–±–∞–≤–∏ 3-5 product –ª–∏–Ω–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–∞
- –î–æ–±–∞–≤–∏ 2-3 recipe –ª–∏–Ω–∫–∞ –∫—ä–¥–µ—Ç–æ –µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ
- –ù–ï —Å–ø–∞–º–≤–∞–π - –ª–∏–Ω–∫–æ–≤–µ—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–∏ –∏ –ø–æ–ª–µ–∑–Ω–∏
- –ò–∑–ø–æ–ª–∑–≤–∞–π —Ä–∞–∑–ª–∏—á–Ω–∏ anchor —Ç–µ–∫—Å—Ç–æ–≤–µ (–Ω–µ –≤–∏–Ω–∞–≥–∏ "–ë–∞—á–æ –ò–ª–∏—è")

SEO –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø:
- –ò–∑–ø–æ–ª–∑–≤–∞–π keywords –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ
- –ó–∞–≥–ª–∞–≤–∏—è (H2, H3) —Å keywords
- –ü—ä—Ä–≤–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ —Å main keyword

–¢–ï–ú–ê–¢–ò–ö–ê:
- –§–æ–∫—É—Å –≤—ä—Ä—Ö—É –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ (–∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ, –∞–π—Ä–∞–Ω, —Å–∏—Ä–µ–Ω–µ)
- –ë—ä–ª–≥–∞—Ä—Å–∫–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞ –∫—É—Ö–Ω—è
- –ó–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–∏ –ø–æ–ª–∑–∏
- –¢—Ä–∞–¥–∏—Ü–∏–∏ –∏ –∫—É–ª—Ç—É—Ä–∞
- –ö–∞—á–µ—Å—Ç–≤–æ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ

–í–ê–ñ–ù–û:
- 3,500 –¥—É–º–∏ (–ù–ï –ø–æ-–º–∞–ª–∫–æ!)
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω, —Ç–æ–ø—ä–ª —Ç–æ–Ω
- –ë–ï–ó –µ–º–æ—Ç–∏–∫–æ–Ω–∏ –ù–ê–í–°–Ø–ö–™–î–ï
- –°–ê–ú–û —Ä–µ–∞–ª–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ —Ä–µ—Ü–µ–ø—Ç–∏ –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏
- –ß–∏—Å—Ç HTML –∫–æ–¥
- –°–ø–æ–º–µ–Ω–∞–π "–ë–∞—á–æ –ò–ª–∏—è" –∫–∞—Ç–æ –ø—Ä–∏–º–µ—Ä –∑–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏

–§–ò–ù–ê–õ–ù–ê –ü–†–û–í–ï–†–ö–ê –ü–†–ï–î–ò –ì–ï–ù–ï–†–ò–†–ê–ù–ï:
1. –ò–º–∞ –ª–∏ –µ–º–æ—Ç–∏–∫–æ–Ω–∏? ‚Üí –ü–†–ï–ú–ê–•–ù–ò –ì–ò –í–ï–î–ù–ê–ì–ê
2. –°–ø–æ–º–µ–Ω–∞—Ç–∏ –ª–∏ —Å–∞ –∏–∑–º–∏—Å–ª–µ–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏? ‚Üí –ó–ê–ú–ï–ù–ò –° –†–ï–ê–õ–ù–ò
3. –ó–≤—É—á–∏ –ª–∏ –∫–∞—Ç–æ –ø—Ä–µ–≤–æ–¥? ‚Üí –ü–†–ï–ù–ê–ü–ò–®–ò –ù–ê –ï–°–¢–ï–°–¢–í–ï–ù –ë–™–õ–ì–ê–†–°–ö–ò`
      },
      {
        role: 'user',
        content: `–°—ä–∑–¥–∞–π CLUSTER guide –∑–∞ —Ç–µ–º–∞: "${title}"
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}
Keywords: ${keywords || '–Ω—è–º–∞'}

Pillar —Ç–µ–º–∏ –∑–∞ —Å–ø–æ–º–µ–Ω–∞–≤–∞–Ω–µ: ${suggestedPillars.join(', ')}

–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—ä–ª–Ω–æ HTML —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ (3,500 –¥—É–º–∏).`
      }
    ];

    let content = await callOpenRouter(contentPrompt, 0.7, 20000);

    // Clean up markdown code fences
    content = content.trim();
    if (content.startsWith('```html')) {
      content = content.replace(/^```html\s*/, '').replace(/\s*```$/, '');
    } else if (content.startsWith('```')) {
      content = content.replace(/^```\s*/, '').replace(/\s*```$/, '');
    }

    // Step 4: Generate metadata with SEO-optimized title
    const metaPrompt = [
      {
        role: 'system',
        content: `–ì–µ–Ω–µ—Ä–∏—Ä–∞–π SEO metadata –∑–∞ —Å—Ç–∞—Ç–∏—è –∑–∞ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏. –í—ä—Ä–Ω–∏ —Å–∞–º–æ –≤–∞–ª–∏–¥–µ–Ω JSON:
{
  "title": "–ê—Ç—Ä–∞–∫—Ç–∏–≤–Ω–æ –∑–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ (55-65 —Å–∏–º–≤–æ–ª–∞)",
  "meta_title": "SEO –∑–∞–≥–ª–∞–≤–∏–µ (50-60 —Å–∏–º–≤–æ–ª–∞)",
  "meta_description": "SEO –æ–ø–∏—Å–∞–Ω–∏–µ (150-160 —Å–∏–º–≤–æ–ª–∞)",
  "slug": "url-friendly-slug-in-latin-only"
}

–ü–†–ê–í–ò–õ–ê –ó–ê –ó–ê–ì–õ–ê–í–ò–Ø:
‚úÖ –ò–∑–ø–æ–ª–∑–≤–∞–π emotional triggers: "—Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–µ–Ω", "–∞–≤—Ç–µ–Ω—Ç–∏—á–µ–Ω", "–¥–æ–º–∞—à–µ–Ω", "–∑–¥—Ä–∞–≤–æ—Å–ª–æ–≤–µ–Ω"
‚úÖ –î–æ–±–∞–≤—è–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞: —Ü–∏—Ñ—Ä–∏, –≥–æ–¥–∏–Ω–∏, –ø—Ä–æ—Ü–µ–Ω—Ç–∏
‚úÖ –í–∫–ª—é—á–∏ –∫–ª—é—á–æ–≤–∏ –¥—É–º–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ
‚úÖ –ê—Ç—Ä–∞–∫—Ç–∏–≤–µ–Ω –µ–∑–∏–∫: "–ü—ä–ª–µ–Ω –≥–∏–¥", "–í—Å–∏—á–∫–æ –∑–∞", "–¢–∞–π–Ω–∏—Ç–µ –Ω–∞", "–ö–∞–∫ –¥–∞"
‚úÖ –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É SEO –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–æ—Å—Ç

–ü–†–ò–ú–ï–†–ò –ó–ê –î–û–ë–†–ò –ó–ê–ì–õ–ê–í–ò–Ø:
‚ùå –õ–æ—à–æ: "–ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ - –ø–æ–ª–∑–∏ –∏ –≤–∏–¥–æ–≤–µ"
‚úÖ –î–æ–±—Ä–æ: "–ë—ä–ª–≥–∞—Ä—Å–∫–æ –∫–∏—Å–µ–ª–æ –º–ª—è–∫–æ: 7 –∑–¥—Ä–∞–≤–Ω–∏ –ø–æ–ª–∑–∏ –∏ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏"

‚ùå –õ–æ—à–æ: "–°–∏—Ä–µ–Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ"
‚úÖ –î–æ–±—Ä–æ: "–ö–∞–∫ —Å–µ –ø—Ä–∞–≤–∏ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ –±—ä–ª–≥–∞—Ä—Å–∫–æ —Å–∏—Ä–µ–Ω–µ: –û—Ç —Ñ–µ—Ä–º–∞—Ç–∞ –¥–æ –º–∞—Å–∞—Ç–∞"

‚ùå –õ–æ—à–æ: "–ú–ª—è–∫–æ –∫–∞—á–µ—Å—Ç–≤–æ"
‚úÖ –î–æ–±—Ä–æ: "5 –Ω–∞—á–∏–Ω–∞ –¥–∞ —Ä–∞–∑–ø–æ–∑–Ω–∞–µ—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ—Ç–æ –ø—Ä—è—Å–Ω–æ –º–ª—è–∫–æ"

–í–ê–ñ–ù–û: slug —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –°–ê–ú–û –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–∞! –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–∞–π –±—ä–ª–≥–∞—Ä—Å–∫–∏ —Ç–µ–∫—Å—Ç –∫—ä–º –ª–∞—Ç–∏–Ω–∏—Ü–∞.
–ü—Ä–∏–º–µ—Ä: "–ö–∏—Å–µ–ª–æ –º–ª—è–∫–æ –ø–æ–ª–∑–∏" ‚Üí "kiselo-mlyako-polzi"`
      },
      {
        role: 'user',
        content: `–ó–∞–≥–ª–∞–≤–∏–µ (–Ω–∞—á–∞–ª–Ω–æ): ${title}\nCategory: ${categoryBg}\n\n–ì–µ–Ω–µ—Ä–∏—Ä–∞–π SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–æ –∑–∞–≥–ª–∞–≤–∏–µ, –∫–æ–µ—Ç–æ –µ –∞—Ç—Ä–∞–∫—Ç–∏–≤–Ω–æ –∏ –∫–ª–∏–∫–∞–±–∏–ª–Ω–æ.`
      }
    ];

    const metaResponse = await callOpenRouter(metaPrompt, 0.5, 500);
    let metadata;
    let optimizedTitle = title; // Default to original title
    try {
      const cleanMeta = metaResponse.trim()
        .replace(/^```json\s*/, '')
        .replace(/\s*```$/, '');
      metadata = JSON.parse(cleanMeta);

      // Use AI-generated optimized title if available
      if (metadata.title) {
        optimizedTitle = metadata.title;
        console.log('[Cluster] ‚úÖ SEO-optimized title:', optimizedTitle);
      }

      // Ensure slug is Latin
      if (optimizedTitle && /[\u0400-\u04FF]/.test(metadata.slug)) {
        console.log('[Cluster] üîç About to call slugify #2 with optimizedTitle:', optimizedTitle, 'type:', typeof optimizedTitle);
        metadata.slug = slugify(optimizedTitle);
      }
    } catch (e) {
      console.error('[Cluster] Metadata parsing failed, using fallback');
      console.log('[Cluster] üîç About to call slugify #3 (fallback) with title:', title, 'type:', typeof title);
      metadata = {
        meta_title: title,
        meta_description: title,
        slug: slugify(title)
      };
    }

    // Step 5: Extract excerpt from TLDR section
    let excerpt = '';
    try {
      const tldrMatch = content.match(/<div class="tldr-section">[\s\S]*?<p>(.*?)<\/p>[\s\S]*?<\/div>/);
      if (tldrMatch) {
        excerpt = tldrMatch[1]
          .replace(/<[^>]*>/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
          .substring(0, 200);
      }
    } catch (e) {
      console.error('[Cluster] Failed to extract excerpt:', e);
    }

    // Step 6: Generate 4 images (1 hero + 3 section images)
    let featuredImageUrl: string | null = null;
    const sectionImageUrls: string[] = [];

    try {
      console.log('[Cluster] Generating 4 images for article...');

      // Image 1: Hero image (general overview)
      const heroPrompt = `Create a photorealistic, high-quality food photography image for article: "${optimizedTitle}".

STYLE: Professional food photography, studio lighting, sharp focus, shallow depth of field, appetizing presentation
SUBJECT: Fresh Bulgarian dairy products (white cheese, yogurt, milk) beautifully arranged on rustic wooden table
DETAILS: Traditional Bulgarian tablecloth or linen, natural morning light, warm earthy tones, authentic Bulgarian kitchen setting
MOOD: Inviting, appetizing, traditional yet modern, clean and fresh
QUALITY: 8K resolution, professional food photography, magazine quality, realistic textures

Category context: ${categoryBg}

IMPORTANT: NO text, NO logos, NO letters visible in the image. Pure photorealistic food photography only.`;

      featuredImageUrl = await generateImage(heroPrompt, `${metadata.slug}-hero`);
      console.log('[Cluster] Hero image generated');

      // Image 2: For "–û—Å–Ω–æ–≤–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏" section - Close-up of specific product
      const section1Prompt = `Create a photorealistic close-up food photography image showing Bulgarian dairy product details.

STYLE: Macro photography, dramatic lighting, extreme close-up, professional food styling
SUBJECT: Single Bulgarian dairy product (yogurt or white cheese) with visible texture and details
DETAILS: Shallow depth of field, focus on texture and quality, wooden spoon or traditional utensil, minimal styling
MOOD: Educational, detailed, artisanal, authentic craftsmanship
QUALITY: 8K resolution, sharp details, magazine quality

Category context: ${categoryBg}

IMPORTANT: NO text, NO logos, NO letters visible in the image. Pure photorealistic food photography only.`;

      const section1Image = await generateImage(section1Prompt, `${metadata.slug}-section-1`);
      if (section1Image) {
        sectionImageUrls.push(section1Image);
        console.log('[Cluster] Section 1 image generated');
      }

      // Image 3: For "–ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ" section - Traditional Bulgarian scene
      const section2Prompt = `Create a photorealistic traditional Bulgarian kitchen scene with dairy products.

STYLE: Environmental food photography, soft natural lighting, wide composition, authentic Bulgarian setting
SUBJECT: Traditional Bulgarian kitchen counter with various dairy products, clay pots, copper vessels
DETAILS: Embroidered traditional cloth, rustic wooden shelves, traditional Bulgarian pottery, warm morning light through window
MOOD: Nostalgic, traditional, homey, authentic Bulgarian heritage
QUALITY: 8K resolution, professional photography, magazine quality

Category context: ${categoryBg}

IMPORTANT: NO text, NO logos, NO letters visible in the image. Pure photorealistic food photography only.`;

      const section2Image = await generateImage(section2Prompt, `${metadata.slug}-section-2`);
      if (section2Image) {
        sectionImageUrls.push(section2Image);
        console.log('[Cluster] Section 2 image generated');
      }

      // Image 4: For "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" section - Ready-to-serve presentation
      const section3Prompt = `Create a photorealistic food photography image of prepared Bulgarian dish with dairy products.

STYLE: Food plating photography, professional presentation, top-down view, editorial food styling
SUBJECT: Beautiful serving of traditional Bulgarian dish featuring dairy products (banitsa, tarator, shopska salad)
DETAILS: Elegant white plate on rustic wooden table, fresh herbs, traditional garnish, clean composition
MOOD: Appetizing, modern yet traditional, ready to serve, inviting
QUALITY: 8K resolution, professional food plating, magazine quality

Category context: ${categoryBg}

IMPORTANT: NO text, NO logos, NO letters visible in the image. Pure photorealistic food photography only.`;

      const section3Image = await generateImage(section3Prompt, `${metadata.slug}-section-3`);
      if (section3Image) {
        sectionImageUrls.push(section3Image);
        console.log('[Cluster] Section 3 image generated');
      }

      console.log(`[Cluster] Generated ${1 + sectionImageUrls.length} images total`);
    } catch (imageError) {
      console.error('[Cluster] Failed to generate images:', imageError);
    }

    // Step 6.5: Inject section images into content
    if (sectionImageUrls.length > 0) {
      try {
        console.log('[Cluster] Injecting section images into content...');

        // Find H2 sections and insert images after them
        let modifiedContent = content;

        // Insert image 1 after section-2 (–û—Å–Ω–æ–≤–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
        if (sectionImageUrls[0]) {
          modifiedContent = modifiedContent.replace(
            /(<h2 id="section-2">.*?<\/h2>)/i,
            `$1\n<div class="my-8 rounded-xl overflow-hidden shadow-lg">\n  <img src="${sectionImageUrls[0]}" alt="–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏—Ç–µ –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏" class="w-full h-auto" />\n</div>`
          );
        }

        // Insert image 2 after section-3 (–ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ)
        if (sectionImageUrls[1]) {
          modifiedContent = modifiedContent.replace(
            /(<h2 id="section-3">.*?<\/h2>)/i,
            `$1\n<div class="my-8 rounded-xl overflow-hidden shadow-lg">\n  <img src="${sectionImageUrls[1]}" alt="–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∞ –∫—É—Ö–Ω—è" class="w-full h-auto" />\n</div>`
          );
        }

        // Insert image 3 after section-4 (–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
        if (sectionImageUrls[2]) {
          modifiedContent = modifiedContent.replace(
            /(<h2 id="section-4">.*?<\/h2>)/i,
            `$1\n<div class="my-8 rounded-xl overflow-hidden shadow-lg">\n  <img src="${sectionImageUrls[2]}" alt="–ì–æ—Ç–æ–≤–æ —è—Å—Ç–∏–µ —Å –º–ª–µ—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏" class="w-full h-auto" />\n</div>`
          );
        }

        content = modifiedContent;
        console.log('[Cluster] Section images injected successfully');
      } catch (injectError) {
        console.error('[Cluster] Failed to inject section images:', injectError);
      }
    }

    // Step 7: Save to database
    const { data: savedPost, error: saveError } = await supabase
      .from('blog_posts')
      .insert({
        title: optimizedTitle, // Use SEO-optimized title
        slug: metadata.slug,
        content,
        excerpt: excerpt || metadata.meta_description,
        category: 'learn-guide',
        guide_type: 'cluster',
        guide_category: categoryBg, // Use Bulgarian category name
        suggested_pillars: suggestedPillars,
        meta_title: metadata.meta_title,
        meta_description: metadata.meta_description,
        featured_image_url: featuredImageUrl,
        is_published: false,
      })
      .select()
      .single();

    if (saveError) {
      console.error('[Cluster] Save error:', saveError);
      throw new Error(`Failed to save cluster: ${saveError.message}`);
    }

    console.log('[Cluster] ‚úÖ Saved successfully:', savedPost.slug);

    // Step 8: Auto-generate pillar articles for the cluster
    const generatedPillars: any[] = [];

    if (suggestedPillars && suggestedPillars.length > 0) {
      console.log(`[Cluster] Starting auto-generation of ${suggestedPillars.length} pillars...`);

      for (let i = 0; i < suggestedPillars.length; i++) {
        const pillarTitle = suggestedPillars[i];
        console.log(`[Pillar ${i + 1}/${suggestedPillars.length}] Generating: "${pillarTitle}"`);

        try {
          // Call create-pillar endpoint internally
          const pillarResponse = await fetch(`${baseUrl}/api/admin/learn-content/create-pillar`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title: pillarTitle,
              category,
              keywords: `${keywords}, ${pillarTitle}`,
              clusterSlug: savedPost.slug,
              relatedPillars: generatedPillars.map(p => p.slug) // Link to already generated pillars
            })
          });

          if (pillarResponse.ok) {
            const pillarData = await pillarResponse.json();
            generatedPillars.push(pillarData.data);
            console.log(`[Pillar ${i + 1}/${suggestedPillars.length}] ‚úÖ Generated: ${pillarData.data.slug}`);
          } else {
            const errorData = await pillarResponse.json();
            console.error(`[Pillar ${i + 1}/${suggestedPillars.length}] ‚ùå Failed:`, errorData.error);
          }

          // Small delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 2000));

        } catch (pillarError) {
          console.error(`[Pillar ${i + 1}/${suggestedPillars.length}] ‚ùå Error:`, pillarError);
        }
      }

      console.log(`[Cluster] ‚úÖ Generated ${generatedPillars.length}/${suggestedPillars.length} pillars`);

      // Step 9: Update cluster content with real internal links to generated pillars
      if (generatedPillars.length > 0) {
        console.log('[Cluster] Updating cluster with internal links to pillars...');

        try {
          let updatedContent = content;

          // Add pillar links to "–ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ" section
          const pillarLinksHtml = generatedPillars
            .map(p => `<li><a href="/blog/learn/${p.slug}" class="text-blue-600 hover:text-blue-800 underline">${p.title}</a></li>`)
            .join('\n');

          // Find the "–ü–æ–¥—Ç–µ–º–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ" section and append links
          updatedContent = updatedContent.replace(
            /(<h2 id="section-3">[\s\S]*?<\/h2>[\s\S]*?<ul>)([\s\S]*?)(<\/ul>)/i,
            `$1$2${pillarLinksHtml}$3`
          );

          // Update database with linked content
          await supabase
            .from('blog_posts')
            .update({ content: updatedContent })
            .eq('id', savedPost.id);

          console.log('[Cluster] ‚úÖ Updated with pillar links');
        } catch (updateError) {
          console.error('[Cluster] Failed to update with pillar links:', updateError);
        }
      }
    }

    return NextResponse.json({
      success: true,
      cluster: savedPost,
      suggested_pillars: suggestedPillars,
      generated_pillars: generatedPillars.map(p => ({ title: p.title, slug: p.slug }))
    });

  } catch (error: any) {
    console.error('Cluster generation error:', error);
    return NextResponse.json(
      { error: error.message || 'Failed to generate cluster' },
      { status: 500 }
    );
  }
}
